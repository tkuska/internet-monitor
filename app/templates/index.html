<!DOCTYPE html>
<html lang="pl" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Internet Monitor</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-body-secondary">

<div class="container my-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üì° Internet Monitor</h2>

        <div>
            <a href="?range=24h" class="btn btn-sm btn-outline-primary {% if range=='24h' %}active{% endif %}">24h</a>
            <a href="?range=7d" class="btn btn-sm btn-outline-primary {% if range=='7d' %}active{% endif %}">7 dni</a>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTheme()">üåô</button>
        </div>
    </div>

    {% if down_stats and down_stats.download_min < minimal_speed or up_stats.upload_min < minimal_speed %}
    <div class="alert alert-danger">
        ‚ö†Ô∏è Wykryto spadek prƒôdko≈õci poni≈ºej {{ minimal_speed }} Mbps
    </div>
    {% endif %}

    <!-- STATYSTYKI -->
    {% if down_stats %}
    <div class="row mb-4">
    <div class="col-md-12 h3">Download</div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>‚¨á Min</h6>
                    <strong>{{ "%.2f"|format(down_stats.download_min) }} Mbps</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>‚¨á Avg</h6>
                    <strong>{{ "%.2f"|format(down_stats.download_avg) }} Mbps</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>‚¨á Max</h6>
                    <strong>{{ "%.2f"|format(down_stats.download_max) }} Mbps</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- STATYSTYKI -->
    {% if up_stats %}
    <div class="row mb-4">
    <div class="col-md-12 h3">Upload</div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>‚¨á Min</h6>
                    <strong>{{ "%.2f"|format(up_stats.upload_min) }} Mbps</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>‚¨á Avg</h6>
                    <strong>{{ "%.2f"|format(up_stats.upload_avg) }} Mbps</strong>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>‚¨á Max</h6>
                    <strong>{{ "%.2f"|format(up_stats.upload_max) }} Mbps</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- WYKRESY -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5>{{ title }}</h5>
            <canvas id="speedChart" height="120"></canvas>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5>Ping</h5>
            <canvas id="pingChart" height="80"></canvas>
        </div>
    </div>

    <!-- TABELA -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                <h5 class="mb-0">Ostatnie pomiary</h5>
                <button id="deleteSelected" class="btn btn-sm btn-danger" disabled>
                    üóëÔ∏è Usu≈Ñ zaznaczone
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                    <thead>
                        <tr>
                            <th style="width: 32px;">
                                <input type="checkbox" class="form-check-input" id="selectAll">
                            </th>
                            <th>Czas</th>
                            <th>Download</th>
                            <th>Upload</th>
                            <th>Ping</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rows %}
                        <tr class="{% if r.download < minimal_speed or r.upload < minimal_speed %}table-danger{% elif r.download < acceptable_speed or r.upload < acceptable_speed %}table-warning{% else %}table-success{% endif %}">
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox" value="{{ r.id }}">
                            </td>
                            <td>{{ r.timestamp }}</td>
                            <td>{{ "%.2f"|format(r.download) }}</td>
                            <td>{{ "%.2f"|format(r.upload) }}</td>
                            <td>{{ r.ping }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
const labels = {{ labels|safe }};
const downloads = {{ downloads|safe }};
const uploads = {{ uploads|safe }};
const pings = {{ pings|safe }};
const MINIMAL_SPEED = {{ minimal_speed }};
const ACCEPTABLE_SPEED = {{ acceptable_speed }};
const MAX_SPEED = {{ max_speed }};

new Chart(speedChart, {
    type: "line",
    data: {
        labels,
        datasets: [
            {
                label: "Download",
                data: downloads,
                borderColor: "#0d6efd", // primary
                tension: 0.3
            },
            {
                label: "Upload",
                data: uploads,
                borderColor: "#198754", // success
                tension: 0.3
            },
            // üî¥ danger
            {
                label: "Prƒôdko≈õƒá minimalna",
                data: Array(labels.length).fill(MINIMAL_SPEED),
                borderColor: "#dc3545",
                backgroundColor: "rgb(220, 53, 69, 0.2)",
                borderWidth: 2,
                borderDash: [6, 6],
                pointRadius: 0,
                fill: true,
                tension: 0.3
            },
            // üü° warning
            {
                label: "Prƒôdko≈õƒá gwarantowana",
                data: Array(labels.length).fill(ACCEPTABLE_SPEED),
                borderColor: "#ffc107",
                backgroundColor: "rgb(255, 193, 7, 0.2)",
                borderWidth: 2,
                borderDash: [6, 6],
                pointRadius: 0,
                fill: true,
                tension: 0.3
            },
            // üü° success
            {
                label: "Prƒôdko≈õƒá oczekiwana",
                data: Array(labels.length).fill(MAX_SPEED),
                borderColor: "#2c8e2c",
                backgroundColor: "rgba(44,142,44, 0.2)",
                borderWidth: 2,
                borderDash: [6, 6],
                pointRadius: 0,
                fill: true,
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                labels: {
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} Mbps`
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: "Mbps"
                }
            }
        }
    }
});

new Chart(pingChart, {
    type: "line",
    data: {
        labels,
        datasets: [
            { label: "Ping (ms)", data: pings, borderColor: "#dc3545", tension: 0.3 }
        ]
    },
    options: {
        responsive: true
    }
});

function toggleTheme() {
    const html = document.documentElement;
    html.dataset.bsTheme = html.dataset.bsTheme === "dark" ? "light" : "dark";
}

setTimeout(() => location.reload(), 300000); // auto-refresh 5 min

const selectAllCheckbox = document.getElementById("selectAll");
const deleteButton = document.getElementById("deleteSelected");
const rowCheckboxes = Array.from(document.querySelectorAll(".row-checkbox"));
const deleteButtonInitialHtml = deleteButton ? deleteButton.innerHTML : "";

function syncBulkSelectionState() {
    if (!deleteButton) {
        return;
    }
    const anyChecked = rowCheckboxes.some(cb => cb.checked);
    const allChecked = rowCheckboxes.length > 0 && rowCheckboxes.every(cb => cb.checked);
    deleteButton.disabled = !anyChecked;
    if (selectAllCheckbox) {
        selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        selectAllCheckbox.checked = rowCheckboxes.length > 0 && allChecked;
    }
}

if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener("change", () => {
        rowCheckboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
        });
        syncBulkSelectionState();
    });
}

rowCheckboxes.forEach(cb => cb.addEventListener("change", syncBulkSelectionState));

if (deleteButton) {
    deleteButton.addEventListener("click", async () => {
        const ids = rowCheckboxes.filter(cb => cb.checked).map(cb => Number(cb.value));
        if (!ids.length) {
            return;
        }
        if (!confirm(`UsunƒÖƒá ${ids.length} wybranych rekord√≥w?`)) {
            return;
        }
        deleteButton.disabled = true;
        deleteButton.innerHTML = "‚è≥ Usuwanie...";
        try {
            const response = await fetch("/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ ids })
            });
            const data = await response.json();
            if (!response.ok) {
                alert(data.error || "Nie uda≈Ço siƒô usunƒÖƒá rekord√≥w.");
                return;
            }
            location.reload();
        } catch (error) {
            console.error(error);
            alert("WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania rekord√≥w.");
        } finally {
            deleteButton.innerHTML = deleteButtonInitialHtml;
            syncBulkSelectionState();
        }
    });
}

syncBulkSelectionState();
</script>

</body>
</html>
